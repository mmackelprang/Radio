@inject ILogger<NowPlayingPanel> Logger
@inject IRaddyRadioService RaddyRadioService
@inject ISpotifyService SpotifyService
@inject ISnackbar Snackbar
@inject PanelService PanelService
@implements IDisposable

<MudPaper Class="pa-4" Style="height: 100%; background-color: #2c2c2c; display: flex; flex-direction: column; justify-content: center; align-items: center;">
  @if (CurrentInput == "Radio")
  {
    <div style="text-align: center; width: 100%;">
      <MudText Typo="Typo.h6" Class="mb-2" Style="color: rgba(255,255,255,0.6);">FM Radio</MudText>
      
      @* LED Display Style Frequency *@
      <div class="led-display" style="background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%); border: 3px solid #424242; border-radius: 8px; padding: 20px 40px; margin: 20px auto; max-width: 600px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: center; align-items: baseline; gap: 10px;">
          <MudText Typo="Typo.h1" Style="font-size: 5rem; font-weight: 700; letter-spacing: 8px; color: #00ff41; text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41, 0 0 30px #00ff41; font-family: 'Courier New', monospace;">
            @Frequency.ToString("F1")
          </MudText>
          <MudText Typo="Typo.h4" Style="color: #00ff41; text-shadow: 0 0 10px #00ff41; font-family: 'Courier New', monospace;">
            MHz
          </MudText>
        </div>
        <div style="margin-top: 10px;">
          <MudText Typo="Typo.h5" Style="color: #00ff41; text-shadow: 0 0 8px #00ff41; font-family: 'Courier New', monospace; letter-spacing: 4px;">
            @Band
          </MudText>
        </div>
      </div>
      
      <MudStack Row="true" Justify="Justify.Center" Class="mt-3" Spacing="2">
        @if (IsStereo)
        {
          <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.Hearing">Stereo</MudChip>
        }
        <MudChip T="string" Color="Color.Info" Size="Size.Small" Icon="@Icons.Material.Filled.SignalCellularAlt">Signal: @SignalStrength%</MudChip>
      </MudStack>
      
      @* Advanced Radio Controls Button *@
      <MudButton Variant="Variant.Filled" 
                 Color="Color.Primary" 
                 StartIcon="@Icons.Material.Filled.Tune" 
                 Class="mt-4"
                 OnClick="OpenRadioControls">
        Advanced Radio Controls
      </MudButton>
    </div>
  }
  else if (CurrentInput == "Spotify")
  {
    <div style="text-align: center; max-width: 500px;">
      @if (!string.IsNullOrEmpty(AlbumArtUrl))
      {
        <MudImage Src="@AlbumArtUrl" Alt="Album Art" Style="width: 250px; height: 250px; border-radius: 8px; margin-bottom: 1rem;" />
      }
      <MudText Typo="Typo.h4" Class="mb-2">@TrackTitle</MudText>
      <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">@Artist</MudText>
      <MudText Typo="Typo.body1" Color="Color.Tertiary">@Album</MudText>
      
      @if (!string.IsNullOrEmpty(Lyrics))
      {
        <MudDivider Class="my-4" />
        <MudText Typo="Typo.body2" Style="max-height: 200px; overflow-y: auto;">
          @Lyrics
        </MudText>
      }
    </div>
  }
  else if (CurrentInput == "Vinyl")
  {
    <div style="text-align: center;">
      <div class="vinyl-record-container">
        <MudIcon Icon="@Icons.Material.Filled.Album" 
                 Class="vinyl-spinning" 
                 Style="font-size: 200px;" 
                 Color="Color.Primary" />
      </div>
      <MudText Typo="Typo.h4" Class="mt-4">Vinyl Turntable</MudText>
      <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">Analog Playback</MudText>
      <MudStack Row="true" Justify="Justify.Center" Class="mt-3" Spacing="2">
        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Icon="@Icons.Material.Filled.FiberManualRecord">
          33â…“ RPM
        </MudChip>
        <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.Hearing">
          Analog
        </MudChip>
      </MudStack>
    </div>
  }
  else if (CurrentInput == "Local")
  {
    <div style="text-align: center;">
      <MudIcon Icon="@Icons.Material.Filled.LibraryMusic" Style="font-size: 150px;" Color="Color.Primary" />
      <MudText Typo="Typo.h4" Class="mt-4">@TrackTitle</MudText>
      <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">@Artist</MudText>
      <MudProgressLinear Color="Color.Primary" Value="@PlaybackProgress" Class="mt-4" />
      <MudText Typo="Typo.body2" Class="mt-2">
        @TimeSpan.FromSeconds(CurrentPosition).ToString(@"mm\:ss") / @TimeSpan.FromSeconds(TotalDuration).ToString(@"mm\:ss")
      </MudText>
    </div>
  }
  else
  {
    <div style="text-align: center;">
      <MudIcon Icon="@Icons.Material.Filled.MusicNote" Style="font-size: 150px;" Color="Color.Tertiary" />
      <MudText Typo="Typo.h5" Color="Color.Secondary" Class="mt-4">No Input Selected</MudText>
    </div>
  }
</MudPaper>

@code {
    [Parameter]
    public string CurrentInput { get; set; } = "Radio";

    // Radio properties
    private double Frequency { get; set; } = 101.5;
    private string Band { get; set; } = "FM";
    private bool IsStereo { get; set; } = true;
    private int SignalStrength { get; set; } = 85;

    // Spotify/Music properties
    private string TrackTitle { get; set; } = "Now Playing";
    private string Artist { get; set; } = "Artist Name";
    private string Album { get; set; } = "Album Name";
    private string AlbumArtUrl { get; set; } = "";
    private string Lyrics { get; set; } = "";

    // Playback properties
    private double PlaybackProgress { get; set; } = 45;
    private int CurrentPosition { get; set; } = 125; // seconds
    private int TotalDuration { get; set; } = 280; // seconds

    private Timer? _timer;

    protected override void OnInitialized()
    {
        _timer = new Timer(async _ => await UpdateNowPlayingInfo(), null, 0, 1000);
    }

    private async Task UpdateNowPlayingInfo()
    {
        try
        {
            switch (CurrentInput)
            {
                case "Radio":
                    var freq = await RaddyRadioService.GetFrequencyAsync();
                    if (freq.HasValue)
                    {
                        Frequency = freq.Value;
                    }
                    // TODO: Add signal strength to IRaddyRadioService
                    SignalStrength = 85; // Placeholder
                    break;
                case "Spotify":
                    var track = await SpotifyService.GetCurrentlyPlayingAsync();
                    if (track != null)
                    {
                        TrackTitle = track.Name;
                        Artist = track.Artist;
                        Album = track.Album;
                        AlbumArtUrl = track.AlbumArtUrl ?? "";
                    }
                    break;
                case "Vinyl":
                    TrackTitle = "Vinyl Turntable";
                    Artist = "Analog Playback";
                    Album = "";
                    AlbumArtUrl = "";
                    break;
                case "Local":
                    TrackTitle = "Local File";
                    Artist = "Now Playing";
                    Album = "";
                    AlbumArtUrl = "";
                    break;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating now playing info");
            Snackbar.Add("Error updating now playing info", Severity.Error);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OpenRadioControls()
    {
        PanelService.OpenPanel("RadioControl");
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
