@using MudBlazor

<MudDialog>
  <DialogContent>
    <MudText Typo="Typo.body1" Class="mb-4">
      Select which devices to hide from the device list. Protected devices cannot be hidden.
    </MudText>
    
    <MudStack Spacing="2">
      @foreach (var device in Devices)
      {
        var isProtected = CannotHideDeviceNames.Any(name => device.Name.Contains(name, StringComparison.OrdinalIgnoreCase));
        var isHidden = HiddenDevices.Contains(device.Id);
        
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
          <MudStack Spacing="0">
            <MudText Typo="Typo.body1">@device.Name</MudText>
            @if (device.IsDefault)
            {
              <MudText Typo="Typo.caption" Color="Color.Primary">(Default)</MudText>
            }
            @if (isProtected)
            {
              <MudText Typo="Typo.caption" Color="Color.Warning">(Protected - Cannot Hide)</MudText>
            }
          </MudStack>
          
          @if (!isProtected)
          {
            <MudSwitch T="bool" 
                       @bind-Value="@VisibleState[device.Id]"
                       Color="Color.Success" 
                       Label="@(VisibleState[device.Id] ? "Visible" : "Hidden")" />
          }
        </MudStack>
      }
    </MudStack>
  </DialogContent>
  
  <DialogActions>
    <MudButton OnClick="Cancel">Cancel</MudButton>
    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveChanges">Save</MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter]
  private MudBlazor.IDialogReference? MudDialog { get; set; }

  [Parameter]
  public List<AudioDeviceInfo> Devices { get; set; } = new();

  [Parameter]
  public HashSet<string> HiddenDevices { get; set; } = new();

  [Parameter]
  public string Title { get; set; } = "Configure Devices";

  [Parameter]
  public List<string> CannotHideDeviceNames { get; set; } = new();

  private Dictionary<string, bool> VisibleState { get; set; } = new();

  protected override void OnInitialized()
  {
    foreach (var device in Devices)
    {
      VisibleState[device.Id] = !HiddenDevices.Contains(device.Id);
    }
  }

  private void Cancel()
  {
    MudDialog?.Close();
  }

  private void SaveChanges()
  {
    var updatedHiddenDevices = new HashSet<string>();
    foreach (var entry in VisibleState)
    {
        if (!entry.Value)
        {
            updatedHiddenDevices.Add(entry.Key);
        }
    }
    MudDialog?.Close(DialogResult.Ok(updatedHiddenDevices));
  }
}
