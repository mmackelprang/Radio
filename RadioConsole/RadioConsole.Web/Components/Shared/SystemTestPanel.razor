@inject IHttpClientFactory HttpClientFactory
@inject ILogger<SystemTestPanel> Logger
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Style="background-color: #2c2c2c;">
  <MudText Typo="Typo.h5" Class="mb-4">System Test Panel</MudText>

  @if (IsTestRunning)
  {
    <MudAlert Severity="Severity.Info" Class="mb-4">
      Test in progress...
    </MudAlert>
  }

  <MudStack Spacing="3">
    <MudText Typo="Typo.h6">Text-to-Speech Tests</MudText>
    <MudGrid>
      <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                   FullWidth="true" OnClick="@(() => TestTTS("Now is the time for all good men to come to the aid of their country.", "male"))"
                   Disabled="@IsTestRunning">
          <MudIcon Icon="@Icons.Material.Filled.RecordVoiceOver" Class="mr-2" />
          TTS - Male Voice
        </MudButton>
      </MudItem>
      <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" 
                   FullWidth="true" OnClick="@(() => TestTTS("Hello World! This is a test.", "female"))"
                   Disabled="@IsTestRunning">
          <MudIcon Icon="@Icons.Material.Filled.RecordVoiceOver" Class="mr-2" />
          TTS - Female Voice
        </MudButton>
      </MudItem>
    </MudGrid>

    <MudDivider />

    <MudText Typo="Typo.h6">Audio File Tests</MudText>
    <MudGrid>
      <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Info" 
                   FullWidth="true" OnClick="@(() => TestTone(300, 2))"
                   Disabled="@IsTestRunning">
          <MudIcon Icon="@Icons.Material.Filled.GraphicEq" Class="mr-2" />
          300Hz Tone (2s)
        </MudButton>
      </MudItem>
      <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Success" 
                   FullWidth="true" OnClick="@(() => TestTone(440, 1))"
                   Disabled="@IsTestRunning">
          <MudIcon Icon="@Icons.Material.Filled.MusicNote" Class="mr-2" />
          440Hz Tone (1s)
        </MudButton>
      </MudItem>
    </MudGrid>

    <MudDivider />

    <MudText Typo="Typo.h6">Event Simulations</MudText>
    <MudGrid>
      <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Warning" 
                   FullWidth="true" OnClick="TestDoorbell"
                   Disabled="@IsTestRunning">
          <MudIcon Icon="@Icons.Material.Filled.Doorbell" Class="mr-2" />
          Doorbell Ring
        </MudButton>
      </MudItem>
      <MudItem xs="12" sm="6">
        <MudButton Variant="Variant.Filled" Color="Color.Tertiary" 
                   FullWidth="true" OnClick="TestBroadcast"
                   Disabled="@IsTestRunning">
          <MudIcon Icon="@Icons.Material.Filled.Cast" Class="mr-2" />
          Broadcast Receipt
        </MudButton>
      </MudItem>
    </MudGrid>

    <MudDivider />

    <MudText Typo="Typo.h6">Custom TTS Alert</MudText>
    <MudStack Spacing="2">
      <MudTextField @bind-Value="CustomTtsText" Label="TTS Message" Variant="Variant.Outlined" 
                    Lines="2" Placeholder="Enter text to speak..." />
      <MudGrid>
        <MudItem xs="12" sm="6">
          <MudSelect @bind-Value="CustomTtsGender" Label="Voice Gender" Variant="Variant.Outlined">
            <MudSelectItem Value="@("male")">Male</MudSelectItem>
            <MudSelectItem Value="@("female")">Female</MudSelectItem>
          </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6">
          <MudNumericField @bind-Value="CustomTtsSpeed" Label="Speed" Variant="Variant.Outlined" 
                          Min="0.5" Max="2.0" Step="0.1" />
        </MudItem>
      </MudGrid>
      <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                 FullWidth="true" OnClick="TestCustomTTS"
                 Disabled="@(IsTestRunning || string.IsNullOrWhiteSpace(CustomTtsText))">
        <MudIcon Icon="@Icons.Material.Filled.VolumeUp" Class="mr-2" />
        Play Custom TTS
      </MudButton>
    </MudStack>

    <MudDivider />

    <MudText Typo="Typo.h6">File-Based Alert</MudText>
    <MudStack Spacing="2">
      <FileSelector Label="Audio File Path" @bind-SelectedPath="AlertFilePath" IsDirectory="false" FileFilter=".mp3,.wav" />
      <MudButton Variant="Variant.Filled" Color="Color.Info" 
                 FullWidth="true" OnClick="TestFileAlert"
                 Disabled="@(IsTestRunning || string.IsNullOrWhiteSpace(AlertFilePath))">
        <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Class="mr-2" />
        Play File Alert (with Ducking)
      </MudButton>
    </MudStack>

    <MudDivider />

    <MudText Typo="Typo.h6">Priority Service Configuration</MudText>
    <MudStack Spacing="2">
      <MudSlider @bind-Value="DuckPercentage" Min="0" Max="100" Step="5" Color="Color.Primary">
        Duck Volume: @DuckPercentage%
      </MudSlider>
      <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                 FullWidth="true" OnClick="UpdateDuckPercentage">
        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
        Update Duck Percentage
      </MudButton>
      <MudAlert Severity="Severity.Info" Dense="true">
        Current Status: @(IsHighPriorityActive ? "High priority active - Music ducked" : "Normal playback")
      </MudAlert>
    </MudStack>

    <MudDivider />

    <MudText Typo="Typo.h6">System Status</MudText>
    <MudSimpleTable Dense="true" Style="background-color: #1e1e1e;">
      <tbody>
        <tr>
          <td><strong>CPU Usage:</strong></td>
          <td>@CpuUsage%</td>
        </tr>
        <tr>
          <td><strong>Memory:</strong></td>
          <td>@MemoryUsage MB</td>
        </tr>
        <tr>
          <td><strong>Uptime:</strong></td>
          <td>@Uptime</td>
        </tr>
        <tr>
          <td><strong>Test Status:</strong></td>
          <td>
            @if (IsTestRunning)
            {
              <MudChip T="string" Color="Color.Warning" Size="Size.Small">Running</MudChip>
            }
            else
            {
              <MudChip T="string" Color="Color.Success" Size="Size.Small">Idle</MudChip>
            }
          </td>
        </tr>
      </tbody>
    </MudSimpleTable>
  </MudStack>
</MudPaper>

@code {
    private bool IsTestRunning { get; set; } = false;
    private bool IsHighPriorityActive { get; set; } = false;
    private int CpuUsage { get; set; } = 25;
    private int MemoryUsage { get; set; } = 512;
    private string Uptime { get; set; } = "1d 5h 23m";
    private int DuckPercentage { get; set; } = 20;
    private string CustomTtsText { get; set; } = "";
    private string CustomTtsGender { get; set; } = "male";
    private double CustomTtsSpeed { get; set; } = 1.0;
    private string AlertFilePath { get; set; } = "";
    private HttpClient? _httpClient;
    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        _httpClient = HttpClientFactory.CreateClient("API");
        _timer = new Timer(async _ => await RefreshStatus(), null, 0, 5000);
    }

    private async Task RefreshStatus()
    {
        if (_httpClient == null) return;
        
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SystemStatusResponse>("/api/test/status");
            if (response != null)
            {
                CpuUsage = response.CpuUsage;
                MemoryUsage = response.MemoryUsage;
                Uptime = response.Uptime ?? "Unknown";
                IsTestRunning = response.IsTestRunning;
            }

            // Also get priority service status
            var priorityStatus = await _httpClient.GetFromJsonAsync<PriorityStatusResponse>("/api/audiopriority/status");
            if (priorityStatus != null)
            {
                IsHighPriorityActive = priorityStatus.IsHighPriorityActive;
                DuckPercentage = (int)(priorityStatus.DuckPercentage * 100);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing test status");
            Snackbar.Add("Error: Could not connect to the API. Please ensure the API project is running.", Severity.Error);
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task TestTTS(string phrase, string voiceGender)
    {
        await RunTest(async () =>
        {
            if (_httpClient == null) return;
            var request = new { phrase, voiceGender, speed = 1.0 };
            var response = await _httpClient.PostAsJsonAsync("/api/test/tts", request);
            response.EnsureSuccessStatusCode();
            Snackbar.Add($"Playing TTS with {voiceGender} voice...", Severity.Info);
        });
    }

    private async Task TestTone(int frequency, int duration)
    {
        await RunTest(async () =>
        {
            if (_httpClient == null) return;
            var request = new { frequency, durationSeconds = duration };
            var response = await _httpClient.PostAsJsonAsync("/api/test/tone", request);
            response.EnsureSuccessStatusCode();
            Snackbar.Add($"Playing {frequency}Hz tone for {duration} seconds...", Severity.Info);
        });
    }

    private async Task TestDoorbell()
    {
        await RunTest(async () =>
        {
            if (_httpClient == null) return;
            var response = await _httpClient.PostAsync("/api/test/doorbell", null);
            response.EnsureSuccessStatusCode();
            Snackbar.Add("Playing doorbell sound...", Severity.Info);
        });
    }

    private async Task TestBroadcast()
    {
        await RunTest(async () =>
        {
            if (_httpClient == null) return;
            var response = await _httpClient.PostAsync("/api/test/broadcast", null);
            response.EnsureSuccessStatusCode();
            Snackbar.Add("Simulating broadcast receipt...", Severity.Info);
        });
    }

    private async Task RunTest(Func<Task> testAction)
    {
        IsTestRunning = true;
        try
        {
            await testAction();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error running test");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsTestRunning = false;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    private async Task TestCustomTTS()
    {
        await RunTest(async () =>
        {
            if (_httpClient == null) return;
            var request = new { phrase = CustomTtsText, voiceGender = CustomTtsGender, speed = (float)CustomTtsSpeed };
            var response = await _httpClient.PostAsJsonAsync("/api/test/tts", request);
            response.EnsureSuccessStatusCode();
            Snackbar.Add($"Playing custom TTS...", Severity.Info);
        });
    }

    private async Task TestFileAlert()
    {
        await RunTest(async () =>
        {
            if (_httpClient == null) return;
            
            // TODO: Full implementation requires server-side file reading and streaming
            // For now, demonstrate the ducking behavior with a tone
            Logger.LogInformation("File alert requested for: {FilePath}", AlertFilePath);
            Snackbar.Add($"File alert demonstration (full implementation pending). Selected: {System.IO.Path.GetFileName(AlertFilePath)}", Severity.Info);
            
            // Demonstrate ducking behavior by triggering a tone as high-priority
            var request = new { frequency = 440, durationSeconds = 2 };
            var response = await _httpClient.PostAsJsonAsync("/api/test/tone", request);
            response.EnsureSuccessStatusCode();
        });
    }

    private async Task UpdateDuckPercentage()
    {
        try
        {
            if (_httpClient == null) return;
            
            var request = new { duckPercentage = DuckPercentage / 100.0f };
            var response = await _httpClient.PostAsJsonAsync("/api/audiopriority/config/duck-percentage", request);
            response.EnsureSuccessStatusCode();
            
            Snackbar.Add($"Duck percentage updated to {DuckPercentage}%", Severity.Success);
            Logger.LogInformation("Duck percentage updated to {Percentage}%", DuckPercentage);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating duck percentage");
            Snackbar.Add("Error updating duck percentage", Severity.Error);
        }
    }

    public class PriorityStatusResponse
    {
        public bool IsHighPriorityActive { get; set; }
        public float DuckPercentage { get; set; }
        public string? Message { get; set; }
    }

    public class SystemStatusResponse
    {
        public int CpuUsage { get; set; }
        public int MemoryUsage { get; set; }
        public string? Uptime { get; set; }
        public bool IsTestRunning { get; set; }
    }
}
