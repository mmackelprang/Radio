@using System.Timers
@implements IDisposable
@inject IHttpClientFactory HttpClientFactory
@inject PanelService PanelService

<div class="global-header">
  <MudGrid Justify="Justify.SpaceBetween">
    <MudItem xs="6">
      <MudText Typo="Typo.h3" Style="font-weight: 400; letter-spacing: 2px;">
        @CurrentDateTime.ToString("yyyy/MMM/dd hh:mm:ss tt")
      </MudText>
    </MudItem>
    <MudItem xs="6" Style="text-align: right;">
      <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" AlignItems="AlignItems.Center">
        @* Status Icons (existing) *@
        <MudTooltip Text="WiFi Status">
          <MudIcon Icon="@Icons.Material.Filled.Wifi" Color="@(IsWifiConnected ? Color.Success : Color.Error)" Size="Size.Large" />
        </MudTooltip>
        <MudTooltip Text="System Status">
          <MudIcon Icon="@Icons.Material.Filled.Computer" Color="@(IsSystemHealthy ? Color.Success : Color.Warning)" Size="Size.Large" />
        </MudTooltip>
        
        @* Panel Control Icons (new) *@
        <MudDivider Vertical="true" FlexItem="true" />
        
        <MudTooltip Text="Configuration">
          <MudIconButton Icon="@Icons.Material.Filled.Settings" 
                         Color="@(PanelService.IsPanelOpen("Configuration") ? Color.Primary : Color.Info)" 
                         OnClick="@(() => PanelService.TogglePanel("Configuration"))"
                         Size="Size.Large" />
        </MudTooltip>
        
        <MudTooltip Text="System Status">
          <MudIconButton Icon="@Icons.Material.Filled.Dashboard" 
                         Color="@(PanelService.IsPanelOpen("SystemStatus") ? Color.Primary : Color.Info)" 
                         OnClick="@(() => PanelService.TogglePanel("SystemStatus"))"
                         Size="Size.Large" />
        </MudTooltip>
        
        <MudTooltip Text="Alerts & Notifications">
          <MudIconButton Icon="@Icons.Material.Filled.Notifications" 
                         Color="@(PanelService.IsPanelOpen("AlertManagement") ? Color.Primary : Color.Info)" 
                         OnClick="@(() => PanelService.TogglePanel("AlertManagement"))"
                         Size="Size.Large" />
        </MudTooltip>
        
        <MudTooltip Text="System Test Panel">
          <MudIconButton Icon="@Icons.Material.Filled.Science" 
                         Color="@(PanelService.IsPanelOpen("SystemTest") ? Color.Primary : Color.Info)" 
                         OnClick="@(() => PanelService.TogglePanel("SystemTest"))"
                         Size="Size.Large" />
        </MudTooltip>
        
        <MudTooltip Text="Radio Controls">
          <MudIconButton Icon="@Icons.Material.Filled.Tune" 
                         Color="@(PanelService.IsPanelOpen("RadioControl") ? Color.Primary : Color.Info)" 
                         OnClick="@(() => PanelService.TogglePanel("RadioControl"))"
                         Size="Size.Large" />
        </MudTooltip>
      </MudStack>
    </MudItem>
  </MudGrid>
</div>

@code {
    private System.Timers.Timer? _timer;
    private HttpClient? _httpClient;
    private DateTime CurrentDateTime { get; set; } = DateTime.Now;
    private bool IsWifiConnected { get; set; } = true;
    private bool IsSystemHealthy { get; set; } = true;

    protected override void OnInitialized()
    {
        _httpClient = HttpClientFactory.CreateClient("API");
        PanelService.OnPanelStateChanged += StateHasChanged;
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += async (sender, e) => await OnTimerElapsed(sender, e);
        _timer.AutoReset = true;
        _timer.Start();
    }

    private async Task OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        CurrentDateTime = DateTime.Now;
        if (CurrentDateTime.Second % 5 == 0) // Check status every 5 seconds
        {
            await UpdateSystemStatus();
            UpdateWifiStatus();
        }
        await InvokeAsync(StateHasChanged);
    }

    private void UpdateWifiStatus()
    {
        IsWifiConnected = System.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable();
    }

    private async Task UpdateSystemStatus()
    {
        if (_httpClient == null) return;
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SystemStatusResponse>("/api/test/status");
            if (response != null)
            {
                IsSystemHealthy = response.CpuUsage < 80 && response.MemoryUsage < 4000;
            }
        }
        catch
        {
            IsSystemHealthy = false;
        }
    }

    public void Dispose()
    {
        PanelService.OnPanelStateChanged -= StateHasChanged;
        _timer?.Dispose();
    }

    public class SystemStatusResponse
    {
        public int CpuUsage { get; set; }
        public int MemoryUsage { get; set; }
    }
}

<style>
  .global-header {
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
    border-bottom: 2px solid #424242;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
</style>
