@using System.Timers
@implements IDisposable
@inject IHttpClientFactory HttpClientFactory

<div class="global-header">
  <MudGrid Justify="Justify.SpaceBetween">
    <MudItem xs="8">
      <MudText Typo="Typo.h3" Style="font-weight: 300; letter-spacing: 2px;">
        @CurrentDateTime.ToString("dddd, MMMM dd, yyyy")
      </MudText>
      <MudText Typo="Typo.h2" Style="font-weight: 700; letter-spacing: 1px;">
        @CurrentDateTime.ToString("hh:mm:ss tt")
      </MudText>
    </MudItem>
    <MudItem xs="4" Style="text-align: right;">
      <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
        <MudTooltip Text="WiFi Status">
          <MudIcon Icon="@Icons.Material.Filled.Wifi" Color="@(IsWifiConnected ? Color.Success : Color.Error)" Size="Size.Large" />
        </MudTooltip>
        <MudTooltip Text="System Status">
          <MudIcon Icon="@Icons.Material.Filled.Computer" Color="@(IsSystemHealthy ? Color.Success : Color.Warning)" Size="Size.Large" />
        </MudTooltip>
      </MudStack>
    </MudItem>
  </MudGrid>
</div>

@code {
    private System.Timers.Timer? _timer;
    private HttpClient? _httpClient;
    private DateTime CurrentDateTime { get; set; } = DateTime.Now;
    private bool IsWifiConnected { get; set; } = true;
    private bool IsSystemHealthy { get; set; } = true;

    protected override void OnInitialized()
    {
        _httpClient = HttpClientFactory.CreateClient("API");
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += async (sender, e) => await OnTimerElapsed(sender, e);
        _timer.AutoReset = true;
        _timer.Start();
    }

    private async Task OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        CurrentDateTime = DateTime.Now;
        if (CurrentDateTime.Second % 5 == 0) // Check status every 5 seconds
        {
            await UpdateSystemStatus();
            UpdateWifiStatus();
        }
        await InvokeAsync(StateHasChanged);
    }

    private void UpdateWifiStatus()
    {
        IsWifiConnected = System.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable();
    }

    private async Task UpdateSystemStatus()
    {
        try
        {
            var response = await _httpClient.GetFromJsonAsync<SystemStatusResponse>("/api/test/status");
            if (response != null)
            {
                IsSystemHealthy = response.CpuUsage < 80 && response.MemoryUsage < 4000;
            }
        }
        catch
        {
            IsSystemHealthy = false;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    public class SystemStatusResponse
    {
        public int CpuUsage { get; set; }
        public int MemoryUsage { get; set; }
    }
}

<style>
  .global-header {
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
    border-bottom: 2px solid #424242;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
</style>
