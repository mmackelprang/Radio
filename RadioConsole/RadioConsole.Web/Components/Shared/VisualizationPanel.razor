@using Microsoft.AspNetCore.SignalR.Client
@using RadioConsole.Core.Interfaces.Audio
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<VisualizationPanel> Logger
@implements IAsyncDisposable
@inject IAudioPlayer AudioPlayer

<MudPaper Class="pa-4" Style="height: 100%; background-color: #2c2c2c;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
    <MudText Typo="Typo.h5">Audio Visualizer</MudText>
    <MudSelect T="VisualizationType" Label="Visualization Type" Value="@selectedVisualizationType" 
               ValueChanged="@OnVisualizationTypeChanged"
               Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 200px;">
      <MudSelectItem Value="@VisualizationType.Spectrum">Spectrum</MudSelectItem>
      <MudSelectItem Value="@VisualizationType.Waveform">Waveform</MudSelectItem>
      <MudSelectItem Value="@VisualizationType.LevelMeter">Level Meter</MudSelectItem>
    </MudSelect>
  </div>
  <canvas id="visualizer-canvas" 
          class="visualizer-canvas" 
          @ref="canvasElement" 
          role="img" 
          aria-label="Real-time audio frequency visualization"></canvas>
</MudPaper>

@code {
  private HubConnection? hubConnection;
  private ElementReference canvasElement;
  private VisualizationType selectedVisualizationType = VisualizationType.Spectrum;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      AudioPlayer.EnableFftDataGeneration(true);
      await InitializeSignalR();
      await InitializeCanvas();
    }
  }

  private async Task OnVisualizationTypeChanged(VisualizationType newType)
  {
    selectedVisualizationType = newType;
    try
    {
      await JS.InvokeVoidAsync("setVisualizationType", newType.ToString().ToLowerInvariant());
      Logger.LogInformation("Visualization type changed to: {Type}", newType);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error changing visualization type");
    }
  }

  private async Task InitializeSignalR()
  {
    try
    {
      hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/visualizerhub"))
        .WithAutomaticReconnect()
        .Build();

      hubConnection.On<float[]>("ReceiveFFTData", async (fftData) =>
      {
        await UpdateVisualization(fftData);
      });

      await hubConnection.StartAsync();
      Logger.LogInformation("Connected to VisualizerHub");
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error connecting to VisualizerHub");
    }
  }

  private async Task InitializeCanvas()
  {
    try
    {
      await JS.InvokeVoidAsync("initializeVisualizer", canvasElement);
      Logger.LogInformation("Visualizer canvas initialized");
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error initializing canvas");
    }
  }

  private async Task UpdateVisualization(float[] fftData)
  {
    try
    {
      await JS.InvokeVoidAsync("updateVisualizerData", fftData);
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error updating visualization");
    }
  }

  public async ValueTask DisposeAsync()
    {
        AudioPlayer.EnableFftDataGeneration(false);
        try
        {
            // Clean up JavaScript visualizer resources
            await JS.InvokeVoidAsync("disposeVisualizer");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error disposing visualizer");
        }

        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

<style>
  .visualizer-canvas {
    width: 100%;
    height: calc(100% - 50px);
    background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
    border-radius: 4px;
    border: 1px solid #424242;
  }
</style>
