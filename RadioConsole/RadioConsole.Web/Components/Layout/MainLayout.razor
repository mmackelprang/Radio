@inherits LayoutComponentBase
@inject PanelService PanelService
@implements IDisposable

<MudThemeProvider Theme="@_customTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="console-container">
  <div class="console-header">
    <GlobalHeader />
  </div>
  
  <div class="console-main">
    <div class="console-panel audio-setup-panel">
      <AudioSetupPanel @bind-SelectedInput="CurrentInput" />
    </div>
    
    <div class="console-panel now-playing-panel">
      <NowPlayingPanel CurrentInput="@CurrentInput" />
    </div>
    
    <div class="console-panel visualization-panel">
      <VisualizationPanel />
    </div>
  </div>

  @* System Test Panel - Slide-out (Updated to use PanelService) *@
  <div class="slide-panel slide-panel-right @(PanelService.IsPanelOpen("SystemTest") ? "open" : "")">
    <MudStack>
      <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h5">
          <MudIcon Icon="@Icons.Material.Filled.Science" Class="mr-2" />
          System Test & Configuration
        </MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                       Color="Color.Default" 
                       OnClick="@(() => PanelService.ClosePanel("SystemTest"))" />
      </MudStack>
      <MudDivider />
      <SystemTestPanel />
    </MudStack>
  </div>

  @* Configuration Panel - Slide-out *@
  <div class="slide-panel slide-panel-right @(PanelService.IsPanelOpen("Configuration") ? "open" : "")">
    <ConfigurationPanel />
  </div>

  @* System Status Panel - Slide-out *@
  <div class="slide-panel slide-panel-right @(PanelService.IsPanelOpen("SystemStatus") ? "open" : "")">
    <SystemStatusPanel />
  </div>

  @* Alert Management Panel - Slide-out *@
  <div class="slide-panel slide-panel-right @(PanelService.IsPanelOpen("AlertManagement") ? "open" : "")">
    <AlertManagementPanel />
  </div>

  @* Radio Control Panel - Slide-out *@
  <div class="slide-panel slide-panel-right @(PanelService.IsPanelOpen("RadioControl") ? "open" : "")">
    <MudStack>
      <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-4">
        <MudText Typo="Typo.h5">
          <MudIcon Icon="@Icons.Material.Filled.Tune" Class="mr-2" />
          Advanced Radio Controls
        </MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                       Color="Color.Default" 
                       OnClick="@(() => PanelService.ClosePanel("RadioControl"))" />
      </MudStack>
      <MudDivider />
      <RaddyRadioControlPanel />
    </MudStack>
  </div>

  @* Backdrop overlay - shown when any panel is open *@
  @if (PanelService.GetOpenPanelCount() > 0)
  {
    <div class="panel-backdrop visible" @onclick="@(() => PanelService.CloseAllPanels())"></div>
  }
</div>

@code {
  private string CurrentInput { get; set; } = "Radio";

  protected override void OnInitialized()
  {
    PanelService.OnPanelStateChanged += StateHasChanged;
  }

  public void Dispose()
  {
    PanelService.OnPanelStateChanged -= StateHasChanged;
  }

  // Custom Material Design 3 theme for dark mode console
  private MudTheme _customTheme = new MudTheme()
  {
    PaletteLight = new PaletteLight()
    {
      Primary = "#1976d2",
      Secondary = "#424242",
      AppbarBackground = "#1e1e1e",
    },
    PaletteDark = new PaletteDark()
    {
      Primary = "#90caf9",
      Secondary = "#ce93d8",
      AppbarBackground = "#1e1e1e",
      Background = "#121212",
      Surface = "#2c2c2c",
      DrawerBackground = "#1e1e1e",
      DrawerText = "rgba(255,255,255, 0.87)",
      DrawerIcon = "rgba(255,255,255, 0.87)",
      TextPrimary = "rgba(255,255,255, 0.87)",
      TextSecondary = "rgba(255,255,255, 0.60)",
      ActionDefault = "#adadad",
      ActionDisabled = "rgba(255,255,255, 0.26)",
      ActionDisabledBackground = "rgba(255,255,255, 0.12)",
      Divider = "rgba(255,255,255, 0.12)",
      DividerLight = "rgba(255,255,255, 0.06)",
      TableLines = "rgba(255,255,255, 0.12)",
      LinesDefault = "rgba(255,255,255, 0.12)",
      LinesInputs = "rgba(255,255,255, 0.3)",
      TextDisabled = "rgba(255,255,255, 0.38)",
    }
  };
}

